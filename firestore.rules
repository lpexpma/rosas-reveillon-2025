rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Parties collection
    match /parties/{partyId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null && 
        (request.resource.data.players[request.auth.uid] != null || 
         isHost(request));
      allow delete: if isHost(request);
      
      function isHost(request) {
        let party = get(/databases/$(database)/documents/parties/$(partyId)).data;
        return party.createdBy == request.auth.uid;
      }
    }
    
    // Photos collection
    match /photos/{photoId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth.uid == resource.data.uploadedBy;
      allow delete: if request.auth.uid == resource.data.uploadedBy;
    }
  }
}